name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (leave empty for latest)'
        required: false
        default: ''

jobs:
  deploy-production:
    runs-on: self-hosted

    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.version || github.sha }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm cache clean --force
        npm install --legacy-peer-deps

    # - name: Run tests
    #   run: npm run test

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist deploy/
        cp -r server deploy/
        cp package.json deploy/
        cp ecosystem.config.js deploy/
        cp nginx.conf deploy/
        cd deploy && tar -czf ../snapify-prod-${{ github.sha }}.tar.gz .

    - name: Deploy to production (local)
      run: |
        # SnapifY Production Deployment (Local)
        cd /var/www/snapify

        echo "ðŸš€ Starting production deployment of SnapifY version ${{ github.sha }}"

        # Create timestamped backup in /var/www/backups
        BACKUP_DIR="/var/www/backups/snapify_prod_backup_$(date +%Y%m%d_%H%M%S)"
        mkdir -p /var/www/backups

        echo "ðŸ“¦ Creating backup..."
        if [ -d "dist" ]; then cp -r dist "$BACKUP_DIR/"; fi
        if [ -d "server" ]; then cp -r server "$BACKUP_DIR/"; fi
        if [ -f "package.json" ]; then cp package.json "$BACKUP_DIR/"; fi
        if [ -f "ecosystem.config.js" ]; then cp ecosystem.config.js "$BACKUP_DIR/"; fi
        if [ -f "snapify.db" ]; then cp snapify.db "$BACKUP_DIR/"; fi
        if [ -f ".env" ]; then cp .env "$BACKUP_DIR/"; fi

        # Extract new deployment
        echo "ðŸ“¦ Extracting new deployment..."
        tar -xzf snapify-prod-${{ github.sha }}.tar.gz

        # Install dependencies
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --production --legacy-peer-deps

        # Create logs directory
        echo "ðŸ“ Setting up logging..."
        mkdir -p logs

        # Stop existing PM2 process gracefully
        echo "ðŸ›‘ Stopping existing application..."
        pm2 stop snapify 2>/dev/null || true
        pm2 delete snapify 2>/dev/null || true

        # Start application with PM2
        echo "â–¶ï¸ Starting application..."
        pm2 start ecosystem.config.js --env production

        # Save PM2 configuration
        pm2 save

        # Wait for application to start
        echo "â³ Waiting for application to start..."
        sleep 20

        # Health check with retries
        echo "ðŸ” Running health checks..."
        HEALTH_CHECK_URL="http://localhost:3001/api/health"
        MAX_RETRIES=3

        for i in $(seq 1 $MAX_RETRIES); do
          echo "Health check attempt $i/$MAX_RETRIES..."
          if curl -f --max-time 15 "$HEALTH_CHECK_URL"; then
            echo "âœ… Production deployment successful!"
            echo "ðŸŒ Application running at: https://snapify.skytech.mk"
            break
          else
            echo "âš ï¸ Health check attempt $i failed"
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ All health checks failed - initiating rollback"

              # Rollback logic
              if [ -d "$BACKUP_DIR" ]; then
                echo "ðŸ”„ Rolling back to previous version..."
                rm -rf dist server package.json ecosystem.config.js 2>/dev/null || true
                cp -r "$BACKUP_DIR"/* ./

                # Restart with backup version
                pm2 stop snapify 2>/dev/null || true
                pm2 delete snapify 2>/dev/null || true
                pm2 start ecosystem.config.js --env production
                pm2 save

                sleep 15

                if curl -f --max-time 15 "$HEALTH_CHECK_URL"; then
                  echo "âœ… Rollback successful - backup version is running"
                  exit 1  # Exit with error to indicate deployment failure
                fi
              fi

              echo "ðŸ’¥ Rollback failed - manual intervention required"
              echo "Check PM2 logs: pm2 logs snapify"
              echo "Backup location: $BACKUP_DIR"
              exit 1
            fi
            sleep 10
          fi
        done

        # Clean up old backups (keep last 5)
        echo "ðŸ§¹ Cleaning up old backups..."
        ls -t /var/www/backups/snapify_prod_backup_* 2>/dev/null | tail -n +6 | xargs rm -rf || true

        # Reload nginx to pick up any changes
        echo "ðŸ”„ Reloading nginx..."
        sudo systemctl reload nginx || echo "Warning: nginx reload failed"

        echo "ðŸŽ‰ Production deployment completed successfully!"
        echo "ðŸ“Š Application Status:"
        pm2 jlist | jq -r '.[] | select(.name=="snapify") | "Name: \(.name), Status: \(.pm2_env.status), CPU: \(.monit.cpu)%, Memory: \(.monit.memory)MB"'
