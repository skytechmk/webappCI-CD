name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (leave empty for latest)'
        required: false
        default: ''

jobs:
  deploy-production:
    runs-on: ubuntu-latest

    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.version || github.sha }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm run test

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist deploy/
        cp -r server deploy/
        cp package.json deploy/
        cp ecosystem.config.js deploy/
        cp nginx.conf deploy/
        cd deploy && tar -czf ../snapify-prod-${{ github.sha }}.tar.gz .

    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/snapify

          # Create timestamped backup
          BACKUP_DIR="backup-$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          if [ -d "dist" ]; then cp -r dist "$BACKUP_DIR/"; fi
          if [ -d "server" ]; then cp -r server "$BACKUP_DIR/"; fi
          if [ -f "package.json" ]; then cp package.json "$BACKUP_DIR/"; fi

          echo "ðŸ“¦ Deploying SnapifY version ${{ github.sha }}"

          # Extract new deployment
          tar -xzf snapify-prod-${{ github.sha }}.tar.gz

          # Install dependencies
          npm ci --production

          # Run database migrations if needed
          # npm run migrate

          # Restart application with zero-downtime
          pm2 reload ecosystem.config.js --env production

          # Wait for application to start
          sleep 15

          # Health check with retries
          for i in {1..3}; do
            if curl -f --max-time 10 http://localhost:3001/api/health; then
              echo "âœ… Production deployment successful"
              break
            else
              echo "âš ï¸ Health check attempt $i failed, retrying..."
              sleep 5
            fi
          done

          # Final health check
          if ! curl -f --max-time 10 http://localhost:3001/api/health; then
            echo "âŒ Production deployment failed - rolling back"

            # Rollback logic
            if [ -d "$BACKUP_DIR" ]; then
              echo "ðŸ”„ Rolling back to previous version"
              rm -rf dist server package.json
              cp -r "$BACKUP_DIR"/* ./
              pm2 reload ecosystem.config.js --env production
              sleep 10

              if curl -f http://localhost:3001/api/health; then
                echo "âœ… Rollback successful"
                exit 1  # Exit with error to indicate deployment failure
              fi
            fi

            echo "ðŸ’¥ Rollback failed - manual intervention required"
            exit 1
          fi

          # Clean up old backups (keep last 5)
          ls -d backup-* 2>/dev/null | sort | head -n -5 | xargs rm -rf || true

          echo "ðŸŽ‰ Production deployment completed successfully"

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      if: success()
      with:
        status: success
        text: "ðŸš€ SnapifY production deployment successful - Version ${{ github.sha }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify deployment failure
      uses: 8398a7/action-slack@v3
      if: failure()
      with:
        status: failure
        text: "ðŸ’¥ SnapifY production deployment failed - Manual intervention required"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}