name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm run test

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist deploy/
        cp -r server deploy/
        cp package.json deploy/
        cp ecosystem.config.js deploy/
        cp nginx.conf deploy/
        cd deploy && tar -czf ../snapify-staging-${{ github.sha }}.tar.gz .

    - name: Deploy to staging server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /var/www/snapify-staging

          # Backup current deployment
          if [ -d "dist" ]; then
            mv dist backup-$(date +%Y%m%d_%H%M%S)
          fi

          # Extract new deployment
          tar -xzf snapify-staging-${{ github.sha }}.tar.gz

          # Install dependencies
          npm ci --production

          # Restart application
          pm2 restart snapify-staging || pm2 start ecosystem.config.js --env staging

          # Wait for application to start
          sleep 10

          # Health check
          if curl -f http://localhost:3002/api/health; then
            echo "✅ Staging deployment successful"

            # Clean up old backups (keep last 3)
            ls -d backup-* 2>/dev/null | head -n -3 | xargs rm -rf || true
          else
            echo "❌ Health check failed"
            exit 1
          fi

    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: "SnapifY staging deployment ${{ job.status == 'success' && 'successful ✅' || 'failed ❌' }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}