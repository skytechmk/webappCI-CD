name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm run test

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist deploy/
        cp -r server deploy/
        cp package.json deploy/
        cp ecosystem.config.js deploy/
        cp nginx.conf deploy/
        cd deploy && tar -czf ../snapify-staging-${{ github.sha }}.tar.gz .

    - name: Deploy to staging server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          # SnapifY Staging Deployment for skytech.mk server
          cd /var/www/snapify-staging

          echo "üöÄ Starting staging deployment..."

          # Create backup directory if it doesn't exist
          mkdir -p /var/www/backups

          # Backup current deployment
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          if [ -d "dist" ]; then
            echo "üì¶ Creating backup..."
            tar -czf "/var/www/backups/snapify_staging_backup_$TIMESTAMP.tar.gz" dist/ server/ package*.json ecosystem.config.cjs .env snapify.db 2>/dev/null || true
          fi

          # Extract new deployment
          echo "üì¶ Extracting new deployment..."
          tar -xzf snapify-staging-${{ github.sha }}.tar.gz

          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --production

          # Create logs directory
          echo "üìù Setting up logging..."
          mkdir -p logs

          # Stop existing PM2 process
          echo "üõë Stopping existing application..."
          pm2 stop snapify-staging 2>/dev/null || true
          pm2 delete snapify-staging 2>/dev/null || true

          # Start application with PM2
          echo "‚ñ∂Ô∏è Starting application..."
          pm2 start ecosystem.config.cjs --name snapify-staging --env staging

          # Save PM2 configuration
          pm2 save

          # Wait for application to start
          echo "‚è≥ Waiting for application to start..."
          sleep 15

          # Health check
          echo "üîç Running health check..."
          if curl -f --max-time 30 http://localhost:3002/api/health; then
            echo "‚úÖ Staging deployment successful!"
            echo "üåê Application running at: http://localhost:3002"

            # Clean up old backups (keep last 3)
            ls -t /var/www/backups/snapify_staging_backup_*.tar.gz 2>/dev/null | tail -n +4 | xargs rm -f || true

            echo "üßπ Cleanup completed"
          else
            echo "‚ùå Health check failed - checking logs..."
            pm2 logs snapify-staging --lines 20
            exit 1
          fi

    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: "SnapifY staging deployment ${{ job.status == 'success' && 'successful ‚úÖ' || 'failed ‚ùå' }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}